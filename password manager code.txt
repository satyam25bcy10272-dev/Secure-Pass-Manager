import json
import base64
import os
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from cryptography.hazmat.backends import default_backend
import getpass
import secrets
import string
from datetime import datetime

class PasswordManager:
    def __init__(self, data_file="passwords.enc", key_file="key.key"):
        self.data_file = data_file
        self.key_file = key_file
        self.fernet = None
        self.master_password = None
       
    def derive_key(self, password: str, salt: bytes) -> bytes:
        """Derive encryption key from master password"""
        kdf = PBKDF2HMAC(
            algorithm=hashes.SHA256(),
            length=32,
            salt=salt,
            iterations=390000,  # Increased iterations for better security
            backend=default_backend()
        )
        key = base64.urlsafe_b64encode(kdf.derive(password.encode()))
        return key
   
    def setup_master_password(self):
        """Setup master password for first-time use"""
        if os.path.exists(self.key_file):
            print("Master password already setup!")
            return True
           
        print("=== Setup Master Password ===")
        print("Master password should be strong and memorable!")
        master_pwd = getpass.getpass("Create master password: ")
       
        # Check minimum password strength
        if len(master_pwd) < 8:
            print("Master password must be at least 8 characters!")
            return False
       
        confirm_pwd = getpass.getpass("Confirm master password: ")
       
        if master_pwd != confirm_pwd:
            print("Passwords don't match!")
            return False
           
        # Generate salt and key
        salt = os.urandom(16)
        key = self.derive_key(master_pwd, salt)
       
        # Save salt and key
        with open(self.key_file, 'wb') as f:
            f.write(salt + key)
           
        # Initialize empty password database
        self.fernet = Fernet(key)
        empty_data = self.fernet.encrypt(json.dumps({}).encode())
        with open(self.data_file, 'wb') as f:
            f.write(empty_data)
           
        print("Master password setup successfully!")
        return True
   
    def authenticate(self):
        """Authenticate with master password"""
        if not os.path.exists(self.key_file):
            print("No master password setup. Run setup first.")
            return False
           
        try:
            with open(self.key_file, 'rb') as f:
                data = f.read()
                salt = data[:16]
                stored_key = data[16:]
               
            master_pwd = getpass.getpass("Enter master password: ")
            derived_key = self.derive_key(master_pwd, salt)
           
            if derived_key == stored_key:
                self.fernet = Fernet(derived_key)
                self.master_password = master_pwd
                return True
            else:
                print("Invalid master password!")
                return False
               
        except Exception as e:
            print(f"Authentication error: {e}")
            return False
   
    def generate_password(self, length=16):
        """Generate cryptographically secure random password"""
        if length < 8:
            print("Password length should be at least 8 characters")
            return None
       
        # Ensure at least one character from each category
        lowercase = string.ascii_lowercase
        uppercase = string.ascii_uppercase
        digits = string.digits
        special = "!@#$%^&*()-_=+[]{}|;:,.<>?"
       
        # Build password with guaranteed character types
        password = [
            secrets.choice(lowercase),
            secrets.choice(uppercase),
            secrets.choice(digits),
            secrets.choice(special)
        ]
       
        # Fill the rest with random characters
        all_characters = lowercase + uppercase + digits + special
        password.extend(secrets.choice(all_characters) for _ in range(length - 4))
       
        # Shuffle to avoid predictable patterns
        password_list = list(password)
        secrets.SystemRandom().shuffle(password_list)
       
        return ''.join(password_list)
   
    def evaluate_password_strength(self, password):
        """Evaluate password strength"""
        if not password:
            return "Very Weak"
           
        score = 0
        if len(password) >= 8: score += 1
        if len(password) >= 12: score += 1
        if len(password) >= 16: score += 1
        if any(c.islower() for c in password): score += 1
        if any(c.isupper() for c in password): score += 1
        if any(c.isdigit() for c in password): score += 1
        if any(c in "!@#$%^&*()-_=+[]{}|;:,.<>?" for c in password): score += 1
       
        strength_map = {
            0: "Very Weak", 1: "Very Weak", 2: "Weak",
            3: "Fair", 4: "Good", 5: "Strong",
            6: "Very Strong", 7: "Excellent"
        }
        return strength_map.get(score, "Very Weak")
   
    def load_passwords(self):
        """Load and decrypt password database"""
        if not self.fernet:
            print("Not authenticated!")
            return {}
       
        if not os.path.exists(self.data_file):
            return {}
           
        try:
            with open(self.data_file, 'rb') as f:
                encrypted_data = f.read()
           
            if not encrypted_data:
                return {}
               
            decrypted_data = self.fernet.decrypt(encrypted_data)
            return json.loads(decrypted_data.decode())
           
        except Exception as e:
            print(f"Error loading passwords: {e}")
            return {}
   
    def save_passwords(self, passwords):
        """Encrypt and save password database"""
        if not self.fernet:
            print("Not authenticated!")
            return False
           
        try:
            encrypted_data = self.fernet.encrypt(json.dumps(passwords, indent=2).encode())
            with open(self.data_file, 'wb') as f:
                f.write(encrypted_data)
            return True
        except Exception as e:
            print(f"Error saving passwords: {e}")
            return False
   
    def add_password(self):
        """Add new password entry"""
        print("\n=== Add New Password ===")
        website = input("Website/App: ").strip()
        if not website:
            print("Website cannot be empty!")
            return
           
        username = input("Username/Email: ").strip()
        if not username:
            print("Username cannot be empty!")
            return
       
        choice = input("Generate password? (y/n): ").lower()
        if choice == 'y':
            try:
                length_input = input("Password length (default 16): ").strip()
                length = int(length_input) if length_input else 16
                password = self.generate_password(length)
                if password:
                    print(f"Generated Password: {password}")
                else:
                    return
            except ValueError:
                print("Invalid length!")
                return
        else:
            password = getpass.getpass("Password: ")
            if not password:
                print("Password cannot be empty!")
                return
           
        strength = self.evaluate_password_strength(password)
        print(f"Password Strength: {strength}")
       
        category = input("Category (optional): ").strip()
        notes = input("Notes (optional): ").strip()
       
        passwords = self.load_passwords()
       
        # Generate unique ID
        entry_id = str(max([int(k) for k in passwords.keys()] + [0]) + 1)
       
        passwords[entry_id] = {
            'website': website,
            'username': username,
            'password': password,
            'category': category,
            'notes': notes,
            'created_at': datetime.now().isoformat(),
            'modified_at': datetime.now().isoformat(),
            'strength': strength
        }
       
        if self.save_passwords(passwords):
            print(f"‚úì Password saved successfully! (ID: {entry_id})")
        else:
            print("‚úó Failed to save password!")
   
    def view_passwords(self):
        """View all stored passwords"""
        passwords = self.load_passwords()
       
        if not passwords:
            print("\nNo passwords stored!")
            return
           
        print(f"\n{'='*60}")
        print(f"STORED PASSWORDS ({len(passwords)} entries)")
        print(f"{'='*60}")
       
        for entry_id, entry in sorted(passwords.items(), key=lambda x: int(x[0])):
            print(f"\n[ID: {entry_id}]")
            print(f"  Website:  {entry['website']}")
            print(f"  Username: {entry['username']}")
            print(f"  Password: {'‚óè' * 12}")  # Masked for security
            if entry.get('category'):
                print(f"  Category: {entry['category']}")
            print(f"  Strength: {entry['strength']}")
            print(f"  Created:  {entry['created_at'][:10]}")
            print(f"{'-'*60}")
   
    def get_password(self):
        """Retrieve specific password"""
        passwords = self.load_passwords()
       
        if not passwords:
            print("\nNo passwords stored!")
            return
           
        self.view_passwords()
        entry_id = input("\nEnter entry ID to view password: ").strip()
       
        if entry_id in passwords:
            entry = passwords[entry_id]
            print(f"\n{'='*60}")
            print("PASSWORD DETAILS")
            print(f"{'='*60}")
            print(f"Website:  {entry['website']}")
            print(f"Username: {entry['username']}")
            print(f"Password: {entry['password']}")  # Show actual password
            if entry.get('category'):
                print(f"Category: {entry['category']}")
            print(f"Strength: {entry['strength']}")
            if entry.get('notes'):
                print(f"Notes:    {entry['notes']}")
            print(f"Created:  {entry['created_at'][:19]}")
            print(f"{'='*60}")
        else:
            print("Entry not found!")
   
    def search_passwords(self):
        """Search passwords by website or category"""
        search_term = input("Enter website name or category to search: ").strip().lower()
       
        if not search_term:
            print("Search term cannot be empty!")
            return
       
        passwords = self.load_passwords()
        results = {}
       
        for entry_id, entry in passwords.items():
            if (search_term in entry['website'].lower() or
                search_term in (entry.get('category') or '').lower() or
                search_term in entry['username'].lower()):
                results[entry_id] = entry
       
        if results:
            print(f"\n{'='*60}")
            print(f"SEARCH RESULTS ({len(results)} found)")
            print(f"{'='*60}")
            for entry_id, entry in results.items():
                print(f"[{entry_id}] {entry['website']} | {entry['username']}")
        else:
            print("No matching entries found!")
   
    def update_password(self):
        """Update existing password entry"""
        passwords = self.load_passwords()
       
        if not passwords:
            print("\nNo passwords stored!")
            return
           
        self.view_passwords()
        entry_id = input("\nEnter entry ID to update: ").strip()
       
        if entry_id not in passwords:
            print("Entry not found!")
            return
       
        entry = passwords[entry_id]
        print(f"\nUpdating entry for: {entry['website']}")
        print("(Press Enter to keep current value)")
       
        new_website = input(f"Website [{entry['website']}]: ").strip()
        new_username = input(f"Username [{entry['username']}]: ").strip()
       
        choice = input("Update password? (y/n): ").lower()
        if choice == 'y':
            gen_choice = input("Generate new password? (y/n): ").lower()
            if gen_choice == 'y':
                try:
                    length_input = input("Password length (default 16): ").strip()
                    length = int(length_input) if length_input else 16
                    new_password = self.generate_password(length)
                    if new_password:
                        print(f"Generated Password: {new_password}")
                    else:
                        new_password = entry['password']
                except ValueError:
                    print("Invalid length! Keeping current password.")
                    new_password = entry['password']
            else:
                new_password = getpass.getpass("New password (Enter to keep current): ")
                if not new_password:
                    new_password = entry['password']
        else:
            new_password = entry['password']
       
        new_category = input(f"Category [{entry.get('category', '')}]: ").strip()
        new_notes = input(f"Notes [{entry.get('notes', '')}]: ").strip()
       
        # Update entry
        passwords[entry_id] = {
            'website': new_website if new_website else entry['website'],
            'username': new_username if new_username else entry['username'],
            'password': new_password,
            'category': new_category if new_category else entry.get('category', ''),
            'notes': new_notes if new_notes else entry.get('notes', ''),
            'created_at': entry['created_at'],
            'modified_at': datetime.now().isoformat(),
            'strength': self.evaluate_password_strength(new_password)
        }
       
        if self.save_passwords(passwords):
            print("‚úì Password updated successfully!")
        else:
            print("‚úó Failed to update password!")
   
    def delete_password(self):
        """Delete password entry"""
        passwords = self.load_passwords()
       
        if not passwords:
            print("\nNo passwords stored!")
            return
           
        self.view_passwords()
        entry_id = input("\nEnter entry ID to delete: ").strip()
       
        if entry_id in passwords:
            confirm = input(f"Delete entry for '{passwords[entry_id]['website']}'? (yes/no): ").lower()
            if confirm == 'yes':
                del passwords[entry_id]
                if self.save_passwords(passwords):
                    print("‚úì Entry deleted successfully!")
                else:
                    print("‚úó Failed to delete entry!")
            else:
                print("Deletion cancelled!")
        else:
            print("Entry not found!")

def main():
    manager = PasswordManager()
   
    print("\n" + "="*60)
    print("üîê SECURE PASSWORD MANAGER")
    print("="*60)
   
    # First-time setup
    if not os.path.exists(manager.key_file):
        print("\nWelcome! Let's setup your Password Manager.")
        if not manager.setup_master_password():
            return
   
    # Authentication
    max_attempts = 3
    for attempt in range(max_attempts):
        if manager.authenticate():
            break
        if attempt < max_attempts - 1:
            print(f"Attempts remaining: {max_attempts - attempt - 1}")
        else:
            print("Maximum attempts reached. Exiting.")
            return
   
    print("\n‚úì Login Successful!")
   
    while True:
        print("\n" + "="*60)
        print("PASSWORD MANAGER MENU")
        print("="*60)
        print("1. Add New Password")
        print("2. View All Passwords")
        print("3. Get Specific Password")
        print("4. Search Passwords")
        print("5. Update Password")
        print("6. Generate Random Password")
        print("7. Delete Password")
        print("8. Exit")
        print("="*60)
       
        choice = input("Choose option (1-8): ").strip()
       
        if choice == '1':
            manager.add_password()
        elif choice == '2':
            manager.view_passwords()
        elif choice == '3':
            manager.get_password()
        elif choice == '4':
            manager.search_passwords()
        elif choice == '5':
            manager.update_password()
        elif choice == '6':
            try:
                length_input = input("Password length (default 16): ").strip()
                length = int(length_input) if length_input else 16
                password = manager.generate_password(length)
                if password:
                    strength = manager.evaluate_password_strength(password)
                    print(f"\nGenerated Password: {password}")
                    print(f"Strength: {strength}")
            except ValueError:
                print("Invalid length!")
        elif choice == '7':
            manager.delete_password()
        elif choice == '8':
            print("\nThank you for using Password Manager. Goodbye! üëã\n")
            break
        else:
            print("Invalid choice! Please select 1-8.")

if __name__ == "__main__":
    main()----------